<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fasta序列分组美化工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a6dcc;
            --primary-dark: #0d4a9e;
            --secondary: #10a881;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light-bg: #f5f7fa;
            --card-bg: #ffffff;
            --border: #d1d8e0;
            --text: #333;
            --text-light: #888;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 25px 30px;
            text-align: center;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(26, 109, 204, 0.3);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
        }

        header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 800;
            position: relative;
            z-index: 2;
        }

        header p {
            font-size: 18px;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .input-section, .output-section {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 12px;
            font-size: 26px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        textarea {
            width: 100%;
            height: 180px;
            padding: 18px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 17px;
            resize: vertical;
            transition: all 0.3s;
            box-shadow: inset 0 3px 10px rgba(0,0,0,0.05);
            background: #f8fafd;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(26, 109, 204, 0.2), inset 0 3px 10px rgba(0,0,0,0.05);
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
        }

        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: #f8fafd;
        }

        input[type="number"]:focus, input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 109, 204, 0.2);
        }

        .radio-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0;
            font-weight: normal;
            cursor: pointer;
            padding: 10px 18px;
            background: #f0f5ff;
            border-radius: 10px;
            transition: all 0.2s;
            font-size: 16px;
        }

        .radio-group label:hover {
            background: #e1ebff;
        }

        .radio-group input[type="radio"]:checked + label {
            background: var(--primary);
            color: white;
        }

        .radio-group input[type="radio"] {
            display: none;
        }

        .marker-controls {
            background: #f8fafd;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.04);
        }

        button {
            padding: 14px 26px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 17px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        button i {
            font-size: 20px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 7px 18px rgba(26, 109, 204, 0.4);
        }

        .btn-secondary {
            background: #e0e6ef;
            color: #444;
        }

        .btn-secondary:hover {
            background: #d1d8e0;
            transform: translateY(-3px);
        }

        .btn-add {
            background: var(--secondary);
            color: white;
        }

        .btn-add:hover {
            background: #0d8a6a;
            transform: translateY(-3px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d35400;
            transform: translateY(-3px);
        }

        .btn-remove {
            background: var(--danger);
            color: white;
            padding: 8px 15px;
            font-size: 14px;
        }

        .btn-remove:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        .action-buttons {
            display: flex;
            gap: 18px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .marker-list {
            margin-top: 20px;
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            background: white;
        }

        .marker-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            margin-bottom: 14px;
            border-radius: 10px;
            background: #f8fafd;
            border-left: 5px solid;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            transition: all 0.3s;
            font-size: 16px;
        }

        .marker-item:hover {
            transform: translateX(8px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.06);
        }

        .marker-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .color-preview {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            display: inline-block;
        }

        .output-container {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            box-shadow: inset 0 4px 15px rgba(0,0,0,0.03);
            min-height: 300px;
            font-size: 18px;
            max-height: 500px;
        }

        .sequence-line {
            display: flex;
            align-items: flex-start;
            margin-bottom: 4px;
        }

        .line-number {
            color: var(--primary);
            font-weight: bold;
            user-select: none;
            font-size: 18px;
            min-width: 5em;
            text-align: right;
            padding-right: 20px;
            flex-shrink: 0;
            padding-top: 2px;
        }

        .line-number-right {
            text-align: left !important;
            padding-left: 20px !important;
            padding-right: 0 !important;
            min-width: 5em;
            flex-shrink: 0;
            padding-top: 2px;
        }

        .sequence-content {
            flex-grow: 1;
            font-size: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre;
            color: #000;
            font-weight: 500;
            line-height: 1.6;
        }

        .highlight-segment {
            border-radius: 4px;
            display: inline;
            position: relative;
        }

        .sequence-content {
            letter-spacing: 0.2px;
        }

        .highlight-background {
            background-color: transparent;
            transition: background-color 0.3s;
        }

        .highlight-text {
            color: inherit;
            font-weight: inherit;
        }

        .legend {
            display: flex;
            flex-direction: column;
            margin-top: 30px;
            padding: 25px;
            background: #f8fafd;
            border-radius: 12px;
            border: 1px solid var(--border);
            font-size: 17px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .legend-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-toggle {
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .legend-toggle:hover {
            transform: scale(1.1);
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            transition: all 0.3s ease;
            max-height: 1000px;
            overflow: hidden;
            padding-top: 15px;
        }

        .legend-items.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .legend-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
        }

        .info-panel {
            background: #e8f4ff;
            border-left: 5px solid var(--primary);
            padding: 18px;
            border-radius: 0 12px 12px 0;
            margin: 25px 0;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.04);
        }

        .download-area {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-light);
            text-align: center;
            padding: 40px;
            background: white;
        }

        .format-selector, .quality-selector, .background-selector, .legend-option {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 18px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 17px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        .line-spacing-control, .number-spacing-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 12px;
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #e0e6ef;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(26, 109, 204, 0.3);
        }

        .export-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #e0e6ef;
            z-index: 1000;
        }

        .export-progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }

        .export-progress-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .legend-items {
                flex-direction: column;
            }
            .legend-item {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="export-progress" id="exportProgress" style="display: none;">
        <div class="export-progress-bar" id="exportProgressBar"></div>
    </div>
    <div class="export-progress-info" id="exportProgressInfo" style="display: none;"></div>
    
    <div class="container">
        <header>
            <h1><i class="fas fa-dna"></i> Fasta序列分组美化工具</h1>
            <p>欢迎关注微信公众号/知乎 - 生信美学</p>
        </header>
        
        <div class="main-content">
            <div class="input-section">
                <div class="section-title">
                    <i class="fas fa-sliders-h"></i> 参数设置
                </div>
                
                <div class="form-group">
                    <label for="sequenceInput"><i class="fas fa-code"></i> 输入原始序列或FASTA序列：</label>
                    <textarea id="sequenceInput" placeholder="输入蛋白序列（例如：MEGGENLVRVSSARLSGSNVWRNSAMDVFSRSSSREDYDDEEALRWAALEKLPTY...">
>Example1
MEGGENLVRVSSARLSGSNVWRNSAMDVFSRSSSREDYDDEEALRWAALEKLPTYSRIRRGLLLEEEGQSREVDITKLDLIERRNLLDRLVKIADEDNEKLLMKLKQRIDRVGLDLPTIEVRFEHLNVDAEARVGSRALPTIFNFTVNILEDFLNYIHILPSRKKPLPILHGVSGIIKPGRMTLLLGPPSSGKTTLLLGLAGKLDKDLKVSGRVTYNGHGMDEFVPQRTSAYISQNDLHIGEMTVRETLAFSARCQGVGDKYEILAELSRREKEANIKPDPDVDIFMKSAWNEGQEANVITDYTLKILGLEICADTLVGDEMIRGISGGQ</textarea>
                </div>
                
                <div class="info-panel">
                    <p><strong><i class="fas fa-info-circle"></i> 使用说明：</strong> 输入氨基酸/碱基序列（支持FASTA格式），设置分组参数，添加需要标记的序列区域，点击提交进行格式化。</p>
                </div>
                
                <div class="control-group">
                    <div class="control-item">
                        <label for="groupSize"><i class="fas fa-object-group"></i> 每个分组大小：</label>
                        <input type="number" id="groupSize" value="10" min="1" max="100">
                    </div>
                    
                    <div class="control-item">
                        <label for="aaPerLine"><i class="fas fa-text-width"></i> 每行氨基酸数：</label>
                        <input type="number" id="aaPerLine" value="80" min="1" max="200">
                    </div>
                    
                    <div class="control-item">
                        <label for="spaceCount"><i class="fas fa-space-shuttle"></i> 分组空格数：</label>
                        <input type="number" id="spaceCount" value="1" min="0" max="5">
                    </div>
                    
                   <div class="control-item">
                        <label><i class="fas fa-text-height"></i> 行间距设置：</label>
                        <div class="line-spacing-control">
                            <input type="range" id="lineSpacing" min="0.2" max="3" step="0.1" value="1.0">
                            <span class="line-spacing-value" id="lineSpacingValue">1.0</span>
                        </div>
                    </div>
                    
                    <div class="control-item">
                        <label><i class="fas fa-sort-numeric-down"></i> 数字显示位置：</label>
                        <div class="radio-group">
                            <input type="radio" id="leftPosition" name="numberPosition" value="left" checked>
                            <label for="leftPosition"><i class="fas fa-align-left"></i> 左侧</label>
                            
                            <input type="radio" id="rightPosition" name="numberPosition" value="right">
                            <label for="rightPosition"><i class="fas fa-align-right"></i> 右侧</label>
                            
                            <input type="radio" id="bothPosition" name="numberPosition" value="both">
                            <label for="bothPosition"><i class="fas fa-align-justify"></i> 左右均显示</label>
                            
                            <input type="radio" id="nonePosition" name="numberPosition" value="none">
                            <label for="nonePosition"><i class="fas fa-eye-slash"></i> 不显示</label>
                        </div>
                    </div>

                      <div class="control-item">
                        <label for="numberSpacing"><i class="fas fa-arrows-alt-h"></i> 行号数字与序列间距：</label>
                        <div class="number-spacing-control">
                            <input type="range" id="numberSpacing" min="5" max="100" step="5" value="10">
                            <span class="number-spacing-value" id="numberSpacingValue">10px</span>
                        </div>
                    </div>
                </div>
                
                <div class="section-title">
                    <i class="fas fa-highlighter"></i> 序列标记设置
                </div>
                
                <div class="marker-controls">
                    <div class="marker-inputs">
                        <div class="control-item">
                            <label for="startPos"><i class="fas fa-play"></i> 起始位置：</label>
                            <input type="number" id="startPos" min="1" value="1">
                        </div>
                        <div class="control-item">
                            <label for="endPos"><i class="fas fa-stop"></i> 结束位置：</label>
                            <input type="number" id="endPos" min="1" value="10">
                        </div>
                        <div class="control-item">
                            <label for="markerColor"><i class="fas fa-palette"></i> 标记颜色：</label>
                            <input type="color" id="markerColor" value="#FF6B6B" style="height: 45px;">
                        </div>
                        <div class="control-item">
                            <label for="markerName"><i class="fas fa-tag"></i> 标记名称：</label>
                            <input type="text" id="markerName" placeholder="例如：功能区">
                        </div>
                        <div class="control-item">
                            <label for="markerType"><i class="fas fa-brush"></i> 标记方式：</label>
                            <select id="markerType">
                                <option value="background">背景颜色</option>
                                <option value="text">字符颜色</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn-add" id="addMarkerBtn">
                        <i class="fas fa-plus-circle"></i> 添加标记
                    </button>
                    
                    <div class="marker-list" id="markerList">
                        <p style="text-align: center; color: var(--text-light); padding: 20px;">
                            <i class="fas fa-inbox"></i> 暂无标记序列
                        </p>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn-primary" id="submitBtn">
                        <i class="fas fa-play"></i> 提交格式化
                    </button>
                    <button class="btn-secondary" id="clearBtn">
                        <i class="fas fa-broom"></i> 清除内容
                    </button>
                    <button class="btn-secondary" id="resetBtn">
                        <i class="fas fa-redo"></i> 重置参数
                    </button>
                </div>
            </div>
            
            <div class="output-section">
                <div class="result-header">
                    <div class="section-title">
                        <i class="fas fa-file-code"></i> 格式化结果
                    </div>
                    <div class="download-area">
                        <div class="format-selector">
                            <label for="downloadFormat"><i class="fas fa-file-export"></i> 格式:</label>
                            <select id="downloadFormat">
                                <option value="png">PNG图片</option>
                                <option value="jpg">JPG图片</option>
                                <option value="tif">TIF图片</option>
                                <option value="svg">SVG矢量图</option>
                                <option value="txt">TXT文本</option>
                            </select>
                        </div>
                        <div class="quality-selector" id="qualitySelector" style="display: none;">
                            <label for="imageQuality"><i class="fas fa-image"></i> 质量:</label>
                            <select id="imageQuality">
                                <option value="1.0">高 (100%)</option>
                                <option value="0.8">中 (80%)</option>
                                <option value="0.6">低 (60%)</option>
                            </select>
                        </div>
                        <div class="resolution-selector" id="resolutionSelector" style="display: none;">
                            <label for="imageResolution"><i class="fas fa-expand"></i> 分辨率:</label>
                            <select id="imageResolution">
                                <option value="1">72 DPI (屏幕)</option>
                                <option value="2">150 DPI (打印)</option>
                                <option value="4">300 DPI (高清)</option>
                            </select>
                        </div>
                        <div class="highres-info" id="highresInfo" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <span>高分辨率导出可能需要更长时间</span>
                        </div>
                        <div class="legend-option">
                            <input type="checkbox" id="includeLegend" checked>
                            <label for="includeLegend">包含图例</label>
                        </div>
                        <div class="background-selector">
                            <label for="backgroundColor"><i class="fas fa-fill-drip"></i> 背景:</label>
                            <input type="color" id="backgroundColor" value="#FFFFFF">
                        </div>
                        <button class="btn-warning" id="downloadBtn">
                            <i class="fas fa-download"></i> 下载结果
                        </button>
                    </div>
                </div>
                
                <div class="output-container" id="outputContainer">
                    <div class="placeholder">
                        <i class="fas fa-file-medical"></i>
                        <h3>提交后，格式化结果将显示在这里</h3>
                        <p>设置参数并点击"提交格式化"按钮生成结果</p>
                    </div>
                </div>
                
                <div class="legend" id="legendContainer">
                    <p style="width: 100%; text-align: center; color: var(--text-light); padding: 20px;">
                        <i class="fas fa-list"></i> 标记图例将显示在这里
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sequenceInput = document.getElementById('sequenceInput');
            const groupSizeInput = document.getElementById('groupSize');
            const aaPerLineInput = document.getElementById('aaPerLine');
            const spaceCountInput = document.getElementById('spaceCount');
            const numberSpacingInput = document.getElementById('numberSpacing');
            const numberSpacingValue = document.getElementById('numberSpacingValue');
            const lineSpacingInput = document.getElementById('lineSpacing');
            const lineSpacingValue = document.getElementById('lineSpacingValue');
            const startPosInput = document.getElementById('startPos');
            const endPosInput = document.getElementById('endPos');
            const markerColorInput = document.getElementById('markerColor');
            const markerNameInput = document.getElementById('markerName');
            const markerTypeSelect = document.getElementById('markerType');
            const addMarkerBtn = document.getElementById('addMarkerBtn');
            const markerList = document.getElementById('markerList');
            const submitBtn = document.getElementById('submitBtn');
            const clearBtn = document.getElementById('clearBtn');
            const resetBtn = document.getElementById('resetBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadFormat = document.getElementById('downloadFormat');
            const imageQuality = document.getElementById('imageQuality');
            const qualitySelector = document.getElementById('qualitySelector');
            const resolutionSelector = document.getElementById('resolutionSelector');
            const highresInfo = document.getElementById('highresInfo');
            const includeLegend = document.getElementById('includeLegend');
            const backgroundColorInput = document.getElementById('backgroundColor');
            const imageResolution = document.getElementById('imageResolution');
            const outputContainer = document.getElementById('outputContainer');
            const legendContainer = document.getElementById('legendContainer');
            const exportProgress = document.getElementById('exportProgress');
            const exportProgressBar = document.getElementById('exportProgressBar');
            const exportProgressInfo = document.getElementById('exportProgressInfo');
            
            let markers = [];
            let formattedSequenceText = "";
            let formattedSequenceData = null;
            let lineSpacing = 1.0;
            let numberSpacing = 20;
            
            numberSpacingInput.addEventListener('input', function() {
                numberSpacing = parseInt(this.value);
                numberSpacingValue.textContent = numberSpacing + 'px';
                
                if (outputContainer.innerHTML && !outputContainer.innerHTML.includes('placeholder')) {
                    applyNumberSpacing();
                }
            });
            
            lineSpacingInput.addEventListener('input', function() {
                lineSpacing = parseFloat(this.value);
                lineSpacingValue.textContent = lineSpacing.toFixed(1);
                
                if (outputContainer.innerHTML && !outputContainer.innerHTML.includes('placeholder')) {
                    applyLineSpacing();
                }
            });
            
            downloadFormat.addEventListener('change', function() {
                if (this.value === 'png' || this.value === 'jpg' || this.value === 'tif') {
                    qualitySelector.style.display = 'flex';
                    resolutionSelector.style.display = 'flex';
                    highresInfo.style.display = 'flex';
                } else {
                    qualitySelector.style.display = 'none';
                    resolutionSelector.style.display = 'none';
                    highresInfo.style.display = 'none';
                }
            });
            
            function applyNumberSpacing() {
                const sequenceLines = outputContainer.querySelectorAll('.sequence-line');
                sequenceLines.forEach(line => {
                    const leftNumber = line.querySelector('.line-number-left');
                    const rightNumber = line.querySelector('.line-number-right');
                    
                    if (leftNumber) {
                        leftNumber.style.paddingRight = numberSpacing + 'px';
                    }
                    if (rightNumber) {
                        rightNumber.style.paddingLeft = numberSpacing + 'px';
                    }
                });
            }
            
            function applyLineSpacing() {
                const sequenceLines = outputContainer.querySelectorAll('.sequence-line');
                sequenceLines.forEach(line => {
                    line.style.lineHeight = `${lineSpacing}`;
                    line.style.minHeight = `${lineSpacing * 1.5}em`;
                });
            }
            
            addMarkerBtn.addEventListener('click', function() {
                const startPos = parseInt(startPosInput.value);
                const endPos = parseInt(endPosInput.value);
                const color = markerColorInput.value;
                const name = markerNameInput.value || `标记${markers.length + 1}`;
                const type = markerTypeSelect.value;
                
                if (isNaN(startPos) || isNaN(endPos)) {
                    alert('请输入有效的位置数值');
                    return;
                }
                
                if (startPos > endPos) {
                    alert('起始位置不能大于结束位置');
                    return;
                }
                
                markers.push({start: startPos, end: endPos, color, name, type});
                renderMarkerList();
                
                startPosInput.value = endPos + 1;
                endPosInput.value = endPos + 10;
                markerNameInput.value = '';
            });
            
            function renderMarkerList() {
                if (markers.length === 0) {
                    markerList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px;"><i class="fas fa-inbox"></i> 暂无标记序列</p>';
                    return;
                }
                
                markerList.innerHTML = '';
                markers.forEach((marker, index) => {
                    const markerItem = document.createElement('div');
                    markerItem.className = 'marker-item fade-in';
                    markerItem.style.borderLeftColor = marker.color;
                    
                    const markerDetails = document.createElement('div');
                    markerDetails.className = 'marker-details';
                    
                    const colorPreview = document.createElement('span');
                    colorPreview.className = 'color-preview';
                    colorPreview.style.backgroundColor = marker.color;
                    
                    const markerText = document.createElement('span');
                    markerText.innerHTML = `${marker.name} (${marker.start}-${marker.end}) <small>${marker.type === 'background' ? '背景' : '字符'}</small>`;
                    
                    markerDetails.appendChild(colorPreview);
                    markerDetails.appendChild(markerText);
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn-remove';
                    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    removeBtn.addEventListener('click', function() {
                        markers.splice(index, 1);
                        renderMarkerList();
                    });
                    
                    markerItem.appendChild(markerDetails);
                    markerItem.appendChild(removeBtn);
                    markerList.appendChild(markerItem);
                });
            }
            
            submitBtn.addEventListener('click', function() {
                const sequence = sequenceInput.value.trim();
                const groupSize = parseInt(groupSizeInput.value);
                const aaPerLine = parseInt(aaPerLineInput.value);
                const spaceCount = parseInt(spaceCountInput.value) || 1;
                const numberPosition = document.querySelector('input[name="numberPosition"]:checked').value;
                
                if (!sequence) {
                    alert('请输入蛋白序列');
                    return;
                }
                
                if (isNaN(groupSize) || groupSize < 1) {
                    alert('分组大小必须是大于0的数字');
                    return;
                }
                
                if (isNaN(aaPerLine) || aaPerLine < 1) {
                    alert('每行氨基酸数必须是大于0的数字');
                    return;
                }
                
                let pureSequence = sequence;
                if (sequence.startsWith('>')) {
                    const lines = sequence.split('\n');
                    pureSequence = lines.slice(1).join('').replace(/\s/g, '');
                } else {
                    pureSequence = sequence.replace(/\s/g, '');
                }
                
                if (pureSequence.length > 100000) {
                    alert('序列长度不能超过100000个字符');
                    return;
                }
                
                const formattedSequence = formatSequence(pureSequence, groupSize, aaPerLine, spaceCount, numberPosition, numberSpacing);
                outputContainer.innerHTML = formattedSequence.html;
                formattedSequenceText = formattedSequence.text;
                formattedSequenceData = formattedSequence.data;
                
                applyLineSpacing();
                applyNumberSpacing();
                renderLegend();
            });
            
            function formatSequence(sequence, groupSize, aaPerLine, spaceCount, numberPosition, numberSpacing) {
                let htmlOutput = '';
                let textOutput = '';
                const dataOutput = [];
                const totalLength = sequence.length;
                const spaceStr = ' '.repeat(spaceCount);
                
                const lines = Math.ceil(totalLength / aaPerLine);
                
                for (let lineIndex = 0; lineIndex < lines; lineIndex++) {
                    const lineStart = lineIndex * aaPerLine;
                    const lineEnd = Math.min(lineStart + aaPerLine, totalLength);
                    const lineSeq = sequence.substring(lineStart, lineEnd);
                    
                    const leftLineNumber = lineStart + 1;
                    const rightLineNumber = lineStart + lineSeq.length;
                    
                    const lineNumberElementLeft = `<div class="line-number line-number-left">${leftLineNumber}</div>`;
                    const lineNumberElementRight = `<div class="line-number line-number-right">${rightLineNumber}</div>`;
                    
                    let htmlLine = '';
                    let textLine = '';
                    const groupsInLine = Math.ceil(lineSeq.length / groupSize);
                    const lineData = {lineNumber: leftLineNumber, rightNumber: rightLineNumber, groups: []};
                    
                    for (let groupIndex = 0; groupIndex < groupsInLine; groupIndex++) {
                        const groupStart = groupIndex * groupSize;
                        const groupEnd = Math.min(groupStart + groupSize, lineSeq.length);
                        const groupSeq = lineSeq.substring(groupStart, groupEnd);
                        
                        let htmlGroup = '';
                        let posInGroup = 0;
                        const groupData = {text: groupSeq, segments: []};
                        
                        while (posInGroup < groupSeq.length) {
                            const globalPos = lineStart + groupStart + posInGroup + 1;
                            const marker = findMarkerForPosition(globalPos);
                            
                            let segmentEnd = posInGroup;
                            if (marker) {
                                const markerEndInGroup = Math.min(marker.end - (lineStart + groupStart), groupSeq.length);
                                segmentEnd = Math.min(markerEndInGroup, groupSeq.length);
                                
                                const segmentText = groupSeq.substring(posInGroup, segmentEnd);
                                if (marker.type === 'background') {
                                    htmlGroup += `<span class="highlight-segment highlight-background" style="background-color: ${marker.color}">${segmentText}</span>`;
                                } else {
                                    htmlGroup += `<span class="highlight-segment highlight-text" style="color: ${marker.color}">${segmentText}</span>`;
                                }
                                groupData.segments.push({text: segmentText, marker});
                            } else {
                                const nextMarkerPos = findNextMarkerPosition(globalPos);
                                if (nextMarkerPos > 0) {
                                    const nextMarkerStartInGroup = nextMarkerPos - (lineStart + groupStart);
                                    segmentEnd = Math.min(nextMarkerStartInGroup, groupSeq.length);
                                } else {
                                    segmentEnd = groupSeq.length;
                                }
                                
                                const segmentText = groupSeq.substring(posInGroup, segmentEnd);
                                htmlGroup += segmentText;
                                groupData.segments.push({text: segmentText, marker: null});
                            }
                            
                            posInGroup = segmentEnd;
                        }
                        
                        if (groupSeq.length < groupSize) {
                            htmlGroup += ' '.repeat(groupSize - groupSeq.length);
                        }
                        
                        htmlLine += htmlGroup;
                        textLine += groupSeq;
                        
                        if (groupIndex < groupsInLine - 1) {
                            htmlLine += spaceStr;
                            textLine += spaceStr;
                        }
                        
                        lineData.groups.push(groupData);
                    }
                    
                    switch(numberPosition) {
                        case 'left':
                            htmlOutput += `<div class="sequence-line fade-in">${lineNumberElementLeft}<div class="sequence-content">${htmlLine}</div></div>`;
                            textOutput += `${leftLineNumber.toString().padStart(6, ' ')}  ${textLine}\n`;
                            break;
                        case 'right':
                            htmlOutput += `<div class="sequence-line fade-in"><div class="sequence-content">${htmlLine}</div>${lineNumberElementRight}</div>`;
                            textOutput += `${textLine}  ${rightLineNumber.toString().padStart(6, ' ')}\n`;
                            break;
                        case 'both':
                            htmlOutput += `<div class="sequence-line fade-in">${lineNumberElementLeft}<div class="sequence-content">${htmlLine}</div>${lineNumberElementRight}</div>`;
                            textOutput += `${leftLineNumber.toString().padStart(6, ' ')}  ${textLine}  ${rightLineNumber.toString().padStart(6, ' ')}\n`;
                            break;
                        case 'none':
                            htmlOutput += `<div class="sequence-line fade-in"><div class="sequence-content">${htmlLine}</div></div>`;
                            textOutput += `${textLine}\n`;
                            break;
                    }
                    
                    dataOutput.push(lineData);
                }
                
                return {
                    html: htmlOutput,
                    text: textOutput,
                    data: {
                        sequence: sequence,
                        groupSize: groupSize,
                        aaPerLine: aaPerLine,
                        spaceCount: spaceCount,
                        numberPosition: numberPosition,
                        numberSpacing: numberSpacing,
                        markers: markers,
                        lines: dataOutput
                    }
                };
            }
            
            function findMarkerForPosition(position) {
                for (const marker of markers) {
                    if (position >= marker.start && position <= marker.end) {
                        return marker;
                    }
                }
                return null;
            }
            
            function findNextMarkerPosition(position) {
                let nextPos = Infinity;
                for (const marker of markers) {
                    if (marker.start > position && marker.start < nextPos) {
                        nextPos = marker.start;
                    }
                }
                return nextPos === Infinity ? 0 : nextPos;
            }
            
            function renderLegend() {
                if (markers.length === 0) {
                    legendContainer.innerHTML = '<p style="width: 100%; text-align: center; color: var(--text-light); padding: 20px;"><i class="fas fa-list"></i> 标记图例将显示在这里</p>';
                    return;
                }
                
                let legendHTML = `
                    <div class="legend-header" id="legendHeader">
                        <div class="legend-title">
                            <i class="fas fa-legend legend-icon"></i> 标记图例 (${markers.length}项)
                        </div>
                        <div class="legend-toggle" id="legendToggle">
                            <i class="fas fa-chevron-up"></i>
                        </div>
                    </div>
                    <div class="legend-items" id="legendItems">
                `;
                
                markers.forEach(marker => {
                    legendHTML += `
                        <div class="legend-item" data-marker-name="${marker.name}" data-positions="${marker.start}-${marker.end}" data-type="${marker.type}">
                            <span class="color-preview" style="background-color: ${marker.color}"></span>
                            <span>${marker.name} (${marker.start}-${marker.end}) 
                                <small>${marker.type === 'background' ? '背景' : '字符'}</small>
                            </span>
                        </div>
                    `;
                });
                
                legendHTML += '</div>';
                legendContainer.innerHTML = legendHTML;
                
                setTimeout(() => {
                    const legendItems = document.getElementById('legendItems');
                    if (!legendItems) return;
                    
                    const items = Array.from(legendItems.querySelectorAll('.legend-item'));
                    const containerWidth = legendItems.offsetWidth - 30;
                    const tempCanvas = document.createElement('canvas');
                    const ctx = tempCanvas.getContext('2d');
                    ctx.font = '16px "Segoe UI", Tahoma, Geneva, Verdana, sans-serif';
                    
                    const itemWidths = items.map(item => {
                        const text = item.querySelector('span:last-child').textContent;
                        const textWidth = ctx.measureText(text).width;
                        return textWidth + 50;
                    });
                    
                    let currentRow = [];
                    let currentRowWidth = 0;
                    const gap = 18;
                    
                    items.forEach((item, index) => {
                        const itemWidth = itemWidths[index];
                        
                        if (currentRowWidth + itemWidth + (currentRow.length > 0 ? gap : 0) > containerWidth && currentRow.length > 0) {
                            currentRow = [item];
                            currentRowWidth = itemWidth;
                        } else {
                            currentRow.push(item);
                            currentRowWidth += itemWidth + (currentRow.length > 1 ? gap : 0);
                        }
                    });
                    
                    legendItems.classList.add('collapsed');
                    document.getElementById('legendToggle').querySelector('i').classList.remove('fa-chevron-up');
                    document.getElementById('legendToggle').querySelector('i').classList.add('fa-chevron-down');
                    
                    document.getElementById('legendToggle').addEventListener('click', function() {
                        legendItems.classList.toggle('collapsed');
                        const icon = this.querySelector('i');
                        if (legendItems.classList.contains('collapsed')) {
                            icon.classList.remove('fa-chevron-up');
                            icon.classList.add('fa-chevron-down');
                        } else {
                            icon.classList.remove('fa-chevron-down');
                            icon.classList.add('fa-chevron-up');
                        }
                    });
                }, 50);
            }
            
            clearBtn.addEventListener('click', function() {
                sequenceInput.value = '';
                outputContainer.innerHTML = '<div class="placeholder"><i class="fas fa-file-medical"></i><h3>提交后，格式化结果将显示在这里</h3><p>设置参数并点击"提交格式化"按钮生成结果</p></div>';
                legendContainer.innerHTML = '<p style="width: 100%; text-align: center; color: var(--text-light); padding: 20px;"><i class="fas fa-list"></i> 标记图例将显示在这里</p>';
                formattedSequenceData = null;
            });
            
            resetBtn.addEventListener('click', function() {
                sequenceInput.value = 'MEKVNEERDAVFEDHIGDRRMKRGQAVDFCHWVSHLIATEIHVSGDQLKGQRHKQEDRFLLEEAFADEMEKTSYDVEVADTPQPHIPIRFRHPPIAGPVHDVFGDAIHDIFQKMCPILSEKWSGRSVRSLLEEAFADEMEKTSYDVEVADTPQPHIPIRFRHPPIAGPVHDVFGDAIHDIFQKMCPILSEKWSG';
                groupSizeInput.value = '10';
                aaPerLineInput.value = '80';
                spaceCountInput.value = '1';
                document.querySelector('input[name="numberPosition"][value="left"]').checked = true;
                numberSpacingInput.value = '20';
                numberSpacingValue.textContent = '20px';
                startPosInput.value = '1';
                endPosInput.value = '10';
                markerColorInput.value = '#FF6B6B';
                markerNameInput.value = '';
                markerTypeSelect.value = 'background';
                lineSpacingInput.value = '1.8';
                lineSpacingValue.textContent = '1.8';
                markers = [];
                renderMarkerList();
                outputContainer.innerHTML = '<div class="placeholder"><i class="fas fa-file-medical"></i><h3>提交后，格式化结果将显示在这里</h3><p>设置参数并点击"提交格式化"按钮生成结果</p></div>';
                legendContainer.innerHTML = '<p style="width: 100%; text-align: center; color: var(--text-light); padding: 20px;"><i class="fas fa-list"></i> 标记图例将显示在这里</p>';
                formattedSequenceData = null;
            });
            
            downloadBtn.addEventListener('click', function() {
                if (!formattedSequenceData) {
                    alert('请先提交格式化序列');
                    return;
                }
                
                const format = downloadFormat.value;
                const sequenceLines = formattedSequenceData.lines.length;
                const MAX_LINES_FOR_IMAGE = 1000;
                
                if ((format === 'png' || format === 'jpg' || format === 'tif') && sequenceLines > MAX_LINES_FOR_IMAGE) {
                    if (!confirm(`序列过长（${sequenceLines}行），图片导出可能耗时较长。是否继续导出图片？`)) {
                        return;
                    }
                }
                
                if (format === 'txt') {
                    downloadAsTXT();
                } else if (format === 'svg') {
                    downloadAsSVG();
                } else {
                    downloadAsImage(format);
                }
            });
            
            function downloadAsTXT() {
                const blob = new Blob([formattedSequenceText], {type: 'text/plain'});
                const link = document.createElement('a');
                link.download = '蛋白序列格式化结果.txt';
                link.href = URL.createObjectURL(blob);
                link.click();
            }
            
            function downloadAsSVG() {
                if (!formattedSequenceData) return;
                
                const sequenceLines = formattedSequenceData.lines;
                const numberPosition = formattedSequenceData.numberPosition;
                const numberSpacing = formattedSequenceData.numberSpacing;
                
                const charWidth = 10;
                const charHeight = 18;
                const lineHeight = parseInt(lineSpacing * 25);
                const groupSize = formattedSequenceData.groupSize;
                const spaceCount = formattedSequenceData.spaceCount || 1;
                
                const maxLineNumber = sequenceLines.length * formattedSequenceData.aaPerLine + 1;
                const lineNumberWidth = Math.max(5 * charWidth, maxLineNumber.toString().length * charWidth);
                const maxLineLength = formattedSequenceData.aaPerLine * charWidth + 
                    (Math.ceil(formattedSequenceData.aaPerLine / formattedSequenceData.groupSize) - 1) * 
                    (formattedSequenceData.spaceCount * charWidth);
                
                let width = 1200;
                const padding = 40;
                
                if (numberPosition === 'left' || numberPosition === 'right') {
                    width = Math.ceil(lineNumberWidth + maxLineLength + padding * 2 + numberSpacing);
                } else if (numberPosition === 'both') {
                    width = Math.ceil(lineNumberWidth * 2 + maxLineLength + padding * 2 + numberSpacing * 2);
                } else {
                    width = Math.ceil(maxLineLength + padding * 2);
                }
                
                let height = sequenceLines.length * lineHeight + 50;
                let svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg width="${width}px" height="${height}px" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
  <rect width="100%" height="100%" fill="white"/>
  <style>
    .sequence-text { font-family: 'Courier New', monospace; font-size: ${charHeight}px; }
    .line-number { font-family: 'Courier New', monospace; font-weight: bold; font-size: ${charHeight}px; fill: #1a6dcc; }
  </style>
`;
                
                let yPos = 50;
                
                sequenceLines.forEach(line => {
                    const leftLineNumber = line.lineNumber;
                    const rightLineNumber = line.rightNumber;
                    const groups = line.groups;
                    
                    let xStart = padding;
                    
                    if (numberPosition === 'left' || numberPosition === 'both') {
                        const xNumber = padding - 10;
                        svgContent += `<text x="${xNumber}" y="${yPos}" class="line-number">${leftLineNumber}</text>\n`;
                        xStart = padding + lineNumberWidth + numberSpacing;
                    }
                    
                    if (numberPosition === 'right' || numberPosition === 'both') {
                        const rightX = numberPosition === 'both' ? 
                            width - padding - lineNumberWidth : 
                            width - padding - lineNumberWidth;
                        svgContent += `<text x="${rightX}" y="${yPos}" class="line-number">${rightLineNumber}</text>\n`;
                    }
                    
                    let xPos = xStart;
                    
                    groups.forEach((group, groupIndex) => {
                        group.segments.forEach(segment => {
                            const text = segment.text;
                            const marker = segment.marker;
                            
                            for (let j = 0; j < text.length; j++) {
                                const char = text[j];
                                if (char !== ' ') {
                                    if (marker && marker.type === 'background') {
                                        svgContent += `<rect x="${xPos}" y="${yPos - charHeight + 3}" width="${charWidth}" height="${charHeight}" fill="${marker.color}" />\n`;
                                    }
                                    
                                    const fill = (marker && marker.type === 'text') ? marker.color : '#000';
                                    svgContent += `<text x="${xPos}" y="${yPos}" class="sequence-text" fill="${fill}">${char}</text>\n`;
                                }
                                xPos += charWidth;
                            }
                        });
                        
                        if (groupIndex < groups.length - 1) {
                            xPos += charWidth * spaceCount;
                        }
                    });
                    
                    yPos += lineHeight;
                });
                
                if (markers.length > 0 && includeLegend.checked) {
                    yPos += 50;
                    svgContent += `<text x="40" y="${yPos}" font-family="Arial" font-size="24" font-weight="bold">图例</text>\n`;
                    
                    let xLegend = 40;
                    const legendStartY = yPos + 40;
                    let currentLegendY = legendStartY;
                    const legendItemWidth = 250;
                    const legendItemHeight = 60;
                    const horizontalSpacing = 20;
                    const verticalSpacing = 30;
                    
                    markers.forEach((marker, index) => {
                        if (xLegend + legendItemWidth > width - 40) {
                            xLegend = 40;
                            currentLegendY += legendItemHeight + verticalSpacing;
                        }
                        
                        svgContent += `<rect x="${xLegend}" y="${currentLegendY - 15}" width="20" height="20" fill="${marker.color}" />\n`;
                        svgContent += `<text x="${xLegend + 30}" y="${currentLegendY}" font-family="Arial" font-size="18">${marker.name} (${marker.start}-${marker.end})</text>\n`;
                        svgContent += `<text x="${xLegend + 30}" y="${currentLegendY + 25}" font-family="Arial" font-size="16" fill="#666">${marker.type === 'background' ? '背景标记' : '字符标记'}</text>\n`;
                        
                        xLegend += legendItemWidth + horizontalSpacing;
                    });
                    
                    height = currentLegendY + legendItemHeight + 50;
                    svgContent = svgContent.replace(`height="${height}px"`, `height="${height}px"`);
                }
                
                svgContent += '</svg>';
                
                const blob = new Blob([svgContent], {type: 'image/svg+xml'});
                const link = document.createElement('a');
                link.download = 'Fasta序列美化结果.svg';
                link.href = URL.createObjectURL(blob);
                link.click();
            }
            
            function downloadAsImage(format) {
                if (!formattedSequenceData) return;
                
                const numberPosition = formattedSequenceData.numberPosition;
                const numberSpacing = formattedSequenceData.numberSpacing;
                const resolution = parseFloat(imageResolution.value) || 1;
                const resolutionText = {1: '72 DPI', 2: '150 DPI', 4: '300 DPI'}[resolution];
                
                exportProgress.style.display = 'block';
                exportProgressInfo.style.display = 'block';
                exportProgressBar.style.width = '0%';
                exportProgressInfo.textContent = `准备导出图片 (${resolutionText})...`;
                
                setTimeout(() => {
                    try {
                        const dpr = window.devicePixelRatio || 1;
                        const fontSize = 20 * resolution;
                        const charWidth = fontSize * 0.6;
                        const lineHeight = fontSize * lineSpacing;
                        const padding = 40 * resolution;
                        const margin = 20 * resolution;
                        
                        const sequenceLines = formattedSequenceData.lines;
                        const totalLines = sequenceLines.length;
                        const linesPerPage = Math.floor((10000 * resolution - padding * 2) / lineHeight);
                        const totalPages = Math.ceil(totalLines / linesPerPage);
                        
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let currentPage = 0;
                        
                        function renderNextPage() {
                            if (currentPage >= totalPages) {
                                exportProgress.style.display = 'none';
                                exportProgressInfo.style.display = 'none';
                                return;
                            }
                            
                            exportProgressBar.style.width = `${((currentPage + 1) / totalPages * 100)}%`;
                            exportProgressInfo.textContent = `正在导出第 ${currentPage + 1}/${totalPages} 页 (${resolutionText})...`;
                            
                            const startLine = currentPage * linesPerPage;
                            const endLine = Math.min(startLine + linesPerPage, totalLines);
                            const pageLines = endLine - startLine;
                            
                            const maxLineLength = formattedSequenceData.aaPerLine * charWidth + 
                                (Math.ceil(formattedSequenceData.aaPerLine / formattedSequenceData.groupSize) - 1) * 
                                (formattedSequenceData.spaceCount * charWidth);
                            
                            const maxLineNumber = totalLines * formattedSequenceData.aaPerLine + 1;
                            const lineNumberWidth = Math.max(5 * charWidth, maxLineNumber.toString().length * charWidth);
                            
                            let logicalWidth = 0;
                            if (numberPosition === 'left' || numberPosition === 'right') {
                                logicalWidth = Math.ceil(lineNumberWidth + maxLineLength + padding * 2 + numberSpacing);
                            } else if (numberPosition === 'both') {
                                logicalWidth = Math.ceil(lineNumberWidth * 2 + maxLineLength + padding * 2 + numberSpacing * 2);
                            } else {
                                logicalWidth = Math.ceil(maxLineLength + padding * 2);
                            }
                            
                            const logicalHeight = padding * 2 + pageLines * lineHeight;
                            
                            let legendHeight = 0;
                            if (markers.length > 0 && includeLegend.checked && currentPage === totalPages - 1) {
                                const rows = Math.ceil(markers.length / 4);
                                legendHeight = 120 * resolution + rows * 80 * resolution;
                            }
                            
                            canvas.width = logicalWidth * dpr;
                            canvas.height = (logicalHeight + legendHeight) * dpr;
                            ctx.scale(dpr, dpr);
                            
                            const bgColor = backgroundColorInput.value || '#FFFFFF';
                            ctx.fillStyle = bgColor;
                            ctx.fillRect(0, 0, logicalWidth, logicalHeight + legendHeight);
                            
                            ctx.font = `bold ${fontSize}px 'Courier New', monospace`;
                            
                            let yPos = padding;
                            
                            for (let i = startLine; i < endLine; i++) {
                                const line = sequenceLines[i];
                                const leftLineNumber = line.lineNumber;
                                const rightLineNumber = line.rightNumber;
                                const groups = line.groups;
                                
                                let xStart = padding;
                                
                                if (numberPosition === 'left' || numberPosition === 'both') {
                                    ctx.fillStyle = '#1a6dcc';
                                    ctx.fillText(leftLineNumber.toString().padStart(5, ' '), padding, yPos);
                                    xStart = padding + lineNumberWidth + numberSpacing;
                                }
                                
                                // 修改右侧行号绘制为左对齐
                                if (numberPosition === 'right' || numberPosition === 'both') {
                                    ctx.fillStyle = '#1a6dcc';
                                    // 设置文本对齐方式为左对齐
                                    ctx.textAlign = 'left';
                                    // 计算右侧行号的起始X坐标，确保所有数字从同一位置开始
                                    const rightX = numberPosition === 'both' ? 
                                        logicalWidth - padding - lineNumberWidth : 
                                        logicalWidth - padding - lineNumberWidth;
                                    // 直接绘制文本，不使用padStart填充
                                    ctx.fillText(rightLineNumber.toString(), rightX, yPos);
                                    // 恢复默认对齐方式
                                    ctx.textAlign = 'start';
                                }
                                
                                if (numberPosition === 'none') {
                                    xStart = padding;
                                }
                                
                                let xPos = xStart;
                                
                                groups.forEach((group, groupIndex) => {
                                    group.segments.forEach(segment => {
                                        const text = segment.text;
                                        const marker = segment.marker;
                                        
                                        for (let j = 0; j < text.length; j++) {
                                            const char = text[j];
                                            if (char !== ' ') {
                                                if (marker && marker.type === 'background') {
                                                    ctx.fillStyle = marker.color;
                                                    ctx.fillRect(xPos - 2, yPos - fontSize + 4, charWidth + 2, fontSize);
                                                }
                                                
                                                ctx.fillStyle = (marker && marker.type === 'text') ? marker.color : '#000';
                                                ctx.fillText(char, xPos, yPos);
                                            }
                                            xPos += charWidth;
                                        }
                                    });
                                    
                                    if (groupIndex < groups.length - 1) {
                                        xPos += charWidth * formattedSequenceData.spaceCount;
                                    }
                                });
                                
                                yPos += lineHeight;
                            }
                            
                            if (currentPage === totalPages - 1 && markers.length > 0 && includeLegend.checked) {
                                const titleY = yPos + 60 * resolution;
                                ctx.font = `bold ${20 * resolution}px Arial`;
                                ctx.fillStyle = '#333';
                                ctx.fillText('图例', padding, titleY);
                                
                                let xLegend = padding;
                                const legendStartY = titleY + 40 * resolution;
                                let currentLegendY = legendStartY;
                                const legendItemWidth = 250 * resolution;
                                const legendItemHeight = 60 * resolution;
                                const horizontalSpacing = 20 * resolution;
                                const verticalSpacing = 30 * resolution;
                                
                                markers.forEach((marker, index) => {
                                    if (xLegend + legendItemWidth > logicalWidth - padding) {
                                        xLegend = padding;
                                        currentLegendY += legendItemHeight + verticalSpacing;
                                    }
                                    
                                    ctx.fillStyle = marker.color;
                                    ctx.fillRect(xLegend, currentLegendY - 15 * resolution, 20 * resolution, 20 * resolution);
                                    
                                    ctx.fillStyle = '#333';
                                    ctx.font = `${16 * resolution}px Arial`;
                                    ctx.fillText(`${marker.name} (${marker.start}-${marker.end})`, xLegend + 30 * resolution, currentLegendY);
                                    
                                    ctx.fillStyle = '#666';
                                    ctx.font = `${14 * resolution}px Arial`;
                                    ctx.fillText(marker.type === 'background' ? '背景标记' : '字符标记', xLegend + 30 * resolution, currentLegendY + 25 * resolution);
                                    
                                    ctx.font = `${16 * resolution}px Arial`;
                                    xLegend += legendItemWidth + horizontalSpacing;
                                });
                            }
                            
                            const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
                            const quality = parseFloat(imageQuality.value);
                            const link = document.createElement('a');
                            link.download = `Fasta序列美化结果_${currentPage + 1}_${resolutionText.replace(' ', '')}.${format}`;
                            link.href = canvas.toDataURL(mimeType, format === 'jpg' ? quality : 1);
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            currentPage++;
                            setTimeout(renderNextPage, 100);
                        }
                        
                        renderNextPage();
                    } catch (error) {
                        console.error('导出图片出错:', error);
                        alert('导出图片时出错: ' + error.message);
                        exportProgress.style.display = 'none';
                        exportProgressInfo.style.display = 'none';
                    }
                }, 100);
            }
            
            renderMarkerList();
        });
    </script>
</body>
</html>
