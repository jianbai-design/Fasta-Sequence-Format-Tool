<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fasta序列分组美化工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a6dcc;
            --primary-dark: #0d4a9e;
            --secondary: #10a881;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light-bg: #f5f7fa;
            --card-bg: #ffffff;
            --border: #d1d8e0;
            --text: #333;
            --text-light: #888;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        html, body {
            height: 100%;
            overflow: auto;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 25px 30px;
            text-align: center;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(26, 109, 204, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
        }
        
        header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 800;
            position: relative;
            z-index: 2;
        }
        
        header p {
            font-size: 18px;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .input-section, .output-section {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            padding: 30px;
            display: flex;
            flex-direction: column;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 12px;
            font-size: 26px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #444;
            display: flex;
            align-items: center;
            font-size: 17px;
        }
        
        label i {
            margin-right: 8px;
            color: var(--primary);
            width: 24px;
            text-align: center;
        }
        
        textarea {
            width: 100%;
            height: 180px;
            padding: 18px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 17px;
            resize: vertical;
            transition: all 0.3s;
            box-shadow: inset 0 3px 10px rgba(0,0,0,0.05);
            background: #f8fafd;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(26, 109, 204, 0.2), inset 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
        }
        
        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: #f8fafd;
        }
        
        input[type="number"]:focus, input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 109, 204, 0.2);
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0;
            font-weight: normal;
            cursor: pointer;
            padding: 10px 18px;
            background: #f0f5ff;
            border-radius: 10px;
            transition: all 0.2s;
            font-size: 16px;
        }
        
        .radio-group label:hover {
            background: #e1ebff;
        }
        
        .radio-group input[type="radio"]:checked + label {
            background: var(--primary);
            color: white;
        }
        
        .radio-group input[type="radio"] {
            display: none;
        }
        
        .marker-controls {
            background: #f8fafd;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 15px rgba(0,0,0,0.04);
        }
        
        .marker-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .marker-actions {
            display: flex;
            gap: 15px;
        }
        
        button {
            padding: 14px 26px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 17px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        button i {
            font-size: 20px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 7px 18px rgba(26, 109, 204, 0.4);
        }
        
        .btn-secondary {
            background: #e0e6ef;
            color: #444;
        }
        
        .btn-secondary:hover {
            background: #d1d8e0;
            transform: translateY(-3px);
        }
        
        .btn-add {
            background: var(--secondary);
            color: white;
        }
        
        .btn-add:hover {
            background: #0d8a6a;
            transform: translateY(-3px);
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #d35400;
            transform: translateY(-3px);
        }
        
        .btn-remove {
            background: var(--danger);
            color: white;
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-remove:hover {
            background: #c0392b;
            transform: scale(1.05);
        }
        
        .action-buttons {
            display: flex;
            gap: 18px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .marker-list {
            margin-top: 20px;
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            background: white;
        }
        
        .marker-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            margin-bottom: 14px;
            border-radius: 10px;
            background: #f8fafd;
            border-left: 5px solid;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .marker-item:hover {
            transform: translateX(8px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.06);
        }
        
        .marker-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .color-preview {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            display: inline-block;
        }
        
        .output-container {
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            box-shadow: inset 0 4px 15px rgba(0,0,0,0.03);
            min-height: 300px;
            font-size: 18px;
            max-height: 500px;
        }
        
        .sequence-line {
            display: flex;
            align-items: flex-start;
            margin-bottom: 4px;
        }
        
        .line-number {
            color: var(--primary);
            font-weight: bold;
            user-select: none;
            font-size: 18px;
            min-width: 5em;
            text-align: right;
            padding-right: 20px;
            flex-shrink: 0;
            padding-top: 2px;
        }
        
        .line-number-right {
            text-align: left;
            padding-left: 20px;
        }
        
        .sequence-content {
            flex-grow: 1;
            font-size: 20px;
            letter-spacing: 1px;
            font-family: 'Courier New', monospace;
            white-space: pre;
            color: #000;
            font-weight: 500;
            line-height: 1.6;
        }
        
        /* 优化标记样式 - 解决重叠问题 */
        .continuous-highlight {
            border-radius: 4px;
            display: inline;
            margin: 0 -1px;
            padding: 0 1px;
            -webkit-box-decoration-break: clone;
            box-decoration-break: clone;
            line-height: 1.6;
            position: relative;
            border: 1px solid transparent;
        }
        
        /* 添加字符间距，防止重叠 */
        .sequence-content {
            letter-spacing: 0.5px;
        }
        
        .highlight-text {
            padding: 0;
            display: inline;
            min-width: 1em;
            text-align: center;
            font-weight: 500;
            font-family: 'Courier New', monospace !important;
            color: #000;
            line-height: 1.6;
        }
        
        .legend {
            display: flex;
            flex-direction: column;
            margin-top: 30px;
            padding: 25px;
            background: #f8fafd;
            border-radius: 12px;
            border: 1px solid var(--border);
            font-size: 17px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .legend-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-toggle {
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .legend-toggle:hover {
            transform: scale(1.1);
        }
        
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            transition: all 0.3s ease;
            max-height: 1000px;
            overflow: hidden;
            padding-top: 15px;
        }
        
        .legend-items.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: all 0.3s;
            flex: 1 0 calc(25% - 18px);
            min-width: 200px;
            margin-bottom: 10px;
        }
        
        .legend-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
        }
        
        .info-panel {
            background: #e8f4ff;
            border-left: 5px solid var(--primary);
            padding: 18px;
            border-radius: 0 12px 12px 0;
            margin: 25px 0;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.04);
        }
        
        .info-panel strong {
            color: var(--primary);
        }
        
        .download-area {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-light);
            text-align: center;
            padding: 40px;
            background: white;
        }
        
        .placeholder i {
            font-size: 60px;
            margin-bottom: 25px;
            color: #d1d8e0;
        }
        
        .placeholder h3 {
            font-size: 26px;
            margin-bottom: 20px;
        }
        
        .placeholder p {
            font-size: 18px;
            max-width: 600px;
            margin: 0 auto 25px;
        }
        
        .format-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 18px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 17px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .format-selector select {
            border: none;
            padding: 0;
            width: auto;
            font-size: 17px;
            background: transparent;
        }
        
        .line-spacing-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 12px;
        }
        
        .line-spacing-value {
            min-width: 45px;
            text-align: center;
            font-weight: bold;
            color: var(--primary);
            font-size: 17px;
        }
        
        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #e0e6ef;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(26, 109, 204, 0.3);
        }
        
        .example-sequence {
            width: 100%;
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            border: 1px dashed var(--border);
        }
        
        /* 添加一些动画效果 */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 新增：解决背景标记重叠问题的样式 */
        .continuous-highlight {
            position: relative;
            z-index: 1;
        }
        
        .continuous-highlight::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 1px solid transparent;
            z-index: -1;
        }
        
        /* 新增：背景颜色选择器 */
        .background-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 18px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 17px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        #backgroundColor {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 0;
        }
        
        #backgroundColor::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
            padding: 0;
        }
        
        #backgroundColor::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        /* 新增：响应式调整 */
        @media (max-width: 992px) {
            .container {
                padding: 15px;
            }
            
            header {
                padding: 20px;
            }
            
            .input-section, .output-section {
                padding: 25px;
            }
            
            .section-title {
                font-size: 22px;
            }
            
            .legend-item {
                flex: 1 0 calc(33% - 18px);
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            header h1 {
                font-size: 26px;
            }
            
            header p {
                font-size: 16px;
            }
            
            .control-group {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 12px;
            }
            
            .download-area {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .output-container {
                font-size: 16px;
            }
            
            .sequence-content {
                font-size: 18px;
            }
            
            .line-number {
                font-size: 16px;
            }
            
            .placeholder {
                padding: 30px 20px;
            }
            
            .placeholder h3 {
                font-size: 22px;
            }
            
            .result-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .format-selector, .quality-selector, .background-selector {
                width: 100%;
                justify-content: space-between;
            }
            
            .legend-item {
                flex: 1 0 calc(50% - 18px);
            }
        }
        
        @media (max-width: 480px) {
            .legend-item {
                flex: 1 0 100%;
            }
        }
        
        /* 导出进度条样式 */
        .export-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #e0e6ef;
            z-index: 1000;
        }
        
        .export-progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }
        
        .export-progress-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
        }
        
        .quality-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 18px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 17px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            margin-left: 10px;
        }
        
        /* 新增：操作提示 */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* 新增：图例选项 */
        .legend-option {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 10px 18px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 17px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .legend-option input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* 新增：分辨率选择器 */
        .resolution-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 18px;
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 17px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        /* 新增：高清提示 */
        .highres-info {
            font-size: 14px;
            color: var(--primary);
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        /* 新增：图例图标 */
        .legend-icon {
            font-size: 20px;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="export-progress" id="exportProgress" style="display: none;">
        <div class="export-progress-bar" id="exportProgressBar"></div>
    </div>
    <div class="export-progress-info" id="exportProgressInfo" style="display: none;"></div>
    
    <div class="container">
        <header>
            <h1><i class="fas fa-dna"></i> Fasta序列分组美化工具</h1>
            <p>欢迎关注微信公众号/知乎 - 稻米爱科研</p>
        </header>
        
        <div class="main-content">
            <div class="input-section">
                <div class="section-title">
                    <i class="fas fa-sliders-h"></i> 参数设置
                </div>
                
                <div class="form-group">
                    <label for="sequenceInput"><i class="fas fa-code"></i> 输入原始序列或FASTA序列：</label>
                    <textarea id="sequenceInput" placeholder="输入蛋白序列（例如：MEGGENLVRVSSARLSGSNVWRNSAMDVFSRSSSREDYDDEEALRWAALEKLPTY...">
>Example1
MEGGENLVRVSSARLSGSNVWRNSAMDVFSRSSSREDYDDEEALRWAALEKLPTYSRIRRGLLLEEEGQSREVDITKLDLIERRNLLDRLVKIADEDNEKLLMKLKQRIDRVGLDLPTIEVRFEHLNVDAEARVGSRALPTIFNFTVNILEDFLNYIHILPSRKKPLPILHGVSGIIKPGRMTLLLGPPSSGKTTLLLGLAGKLDKDLKVSGRVTYNGHGMDEFVPQRTSAYISQNDLHIGEMTVRETLAFSARCQGVGDKYEILAELSRREKEANIKPDPDVDIFMKSAWNEGQEANVITDYTLKILGLEICADTLVGDEMIRGISGGQ</textarea>
                </div>
                
                <div class="info-panel">
                    <p><strong><i class="fas fa-info-circle"></i> 使用说明：</strong> 输入氨基酸/碱基序列（支持FASTA格式），设置分组参数，添加需要标记的序列区域，点击提交进行格式化。</p>
                </div>
                
                <div class="control-group">
                    <div class="control-item">
                        <label for="groupSize"><i class="fas fa-object-group"></i> 每个分组大小：</label>
                        <input type="number" id="groupSize" value="10" min="1" max="100">
                    </div>
                    
                    <div class="control-item">
                        <label for="aaPerLine"><i class="fas fa-text-width"></i> 每行氨基酸数：</label>
                        <input type="number" id="aaPerLine" value="80" min="1" max="200">
                    </div>
                    
                    <div class="control-item">
                        <label for="spaceCount"><i class="fas fa-space-shuttle"></i> 分组空格数：</label>
                        <input type="number" id="spaceCount" value="1" min="0" max="5">
                    </div>
                    
                    <div class="control-item">
                        <label><i class="fas fa-sort-numeric-down"></i> 数字显示位置：</label>
                        <div class="radio-group">
                            <input type="radio" id="leftPosition" name="numberPosition" value="left" checked>
                            <label for="leftPosition"><i class="fas fa-align-left"></i> 左边</label>
                            
                            <input type="radio" id="rightPosition" name="numberPosition" value="right">
                            <label for="rightPosition"><i class="fas fa-align-right"></i> 右边</label>
                        </div>
                    </div>
                    
                    <div class="control-item">
                        <label><i class="fas fa-text-height"></i> 行间距设置：</label>
                        <div class="line-spacing-control">
                            <input type="range" id="lineSpacing" min="0.2" max="3" step="0.1" value="1.0">
                            <span class="line-spacing-value" id="lineSpacingValue">1.0</span>
                        </div>
                    </div>
                </div>
                
                <div class="section-title">
                    <i class="fas fa-highlighter"></i> 序列标记设置
                </div>
                
                <div class="marker-controls">
                    <div class="marker-inputs">
                        <div class="control-item">
                            <label for="startPos"><i class="fas fa-play"></i> 起始位置：</label>
                            <input type="number" id="startPos" min="1" value="1">
                        </div>
                        <div class="control-item">
                            <label for="endPos"><i class="fas fa-stop"></i> 结束位置：</label>
                            <input type="number" id="endPos" min="1" value="10">
                        </div>
                        <div class="control-item">
                            <label for="markerColor"><i class="fas fa-palette"></i> 标记颜色：</label>
                            <input type="color" id="markerColor" value="#FF6B6B" style="height: 45px;">
                        </div>
                        <div class="control-item">
                            <label for="markerName"><i class="fas fa-tag"></i> 标记名称：</label>
                            <input type="text" id="markerName" placeholder="例如：功能区">
                        </div>
                        <div class="control-item">
                            <label for="markerType"><i class="fas fa-brush"></i> 标记方式：</label>
                            <select id="markerType">
                                <option value="background">背景颜色</option>
                                <option value="text">字符颜色</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn-add" id="addMarkerBtn">
                        <i class="fas fa-plus-circle"></i> 添加标记
                    </button>
                    
                    <div class="marker-list" id="markerList">
                        <p style="text-align: center; color: var(--text-light); padding: 20px;">
                            <i class="fas fa-inbox"></i> 暂无标记序列
                        </p>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn-primary" id="submitBtn">
                        <i class="fas fa-play"></i> 提交格式化
                    </button>
                    <button class="btn-secondary" id="clearBtn">
                        <i class="fas fa-broom"></i> 清除内容
                    </button>
                    <button class="btn-secondary" id="resetBtn">
                        <i class="fas fa-redo"></i> 重置参数
                    </button>
                </div>
            </div>
            
            <div class="output-section">
                <div class="result-header">
                    <div class="section-title">
                        <i class="fas fa-file-code"></i> 格式化结果
                    </div>
                    <div class="download-area">
                        <div class="format-selector">
                            <label for="downloadFormat"><i class="fas fa-file-export"></i> 格式:</label>
                            <select id="downloadFormat">
                                <option value="png">PNG图片</option>
                                <option value="jpg">JPG图片</option>
                                <option value="tif">TIF图片</option>
                                <option value="svg">SVG矢量图</option>
                                <option value="txt">TXT文本</option>
                            </select>
                        </div>
                        <div class="quality-selector" id="qualitySelector" style="display: none;">
                            <label for="imageQuality"><i class="fas fa-image"></i> 质量:</label>
                            <select id="imageQuality">
                                <option value="1.0">高 (100%)</option>
                                <option value="0.8">中 (80%)</option>
                                <option value="0.6">低 (60%)</option>
                            </select>
                        </div>
                        <div class="resolution-selector" id="resolutionSelector" style="display: none;">
                            <label for="imageResolution"><i class="fas fa-expand"></i> 分辨率:</label>
                            <select id="imageResolution">
                                <option value="1">72 DPI (屏幕)</option>
                                <option value="2">150 DPI (打印)</option>
                                <option value="4">300 DPI (高清)</option>
                            </select>
                        </div>
                        <div class="highres-info" id="highresInfo" style="display: none;">
                            <i class="fas fa-info-circle"></i>
                            <span>高分辨率导出可能需要更长时间</span>
                        </div>
                        <div class="legend-option">
                            <input type="checkbox" id="includeLegend" checked>
                            <label for="includeLegend">包含图例</label>
                        </div>
                        <!-- 新增背景颜色选择器 -->
                        <div class="background-selector">
                            <label for="backgroundColor"><i class="fas fa-fill-drip"></i> 背景:</label>
                            <input type="color" id="backgroundColor" value="#FFFFFF">
                        </div>
                        <button class="btn-warning" id="downloadBtn">
                            <i class="fas fa-download"></i> 下载结果
                        </button>
                    </div>
                </div>
                
                <div class="output-container" id="outputContainer">
                    <div class="placeholder">
                        <i class="fas fa-file-medical"></i>
                        <h3>提交后，格式化结果将显示在这里</h3>
                        <p>设置参数并点击"提交格式化"按钮生成结果</p>
                        <div class="example-sequence">
                            <div class="sequence-line">
                                <div class="line-number line-number-left">1</div>
                                <div class="sequence-content">MEKVNEERDA VFEDHIGDRR MRKGQAVDFC HWVSHLIATE</div>
                            </div>
                            <div class="sequence-line">
                                <div class="line-number line-number-left">41</div>
                                <div class="sequence-content">IHVSGDQLKG QRHKQEDRFL LEEAFADEME KTSYDVEVAD</div>
                            </div>
                            <div class="sequence-line">
                                <div class="line-number line-number-left">81</div>
                                <div class="sequence-content">TPQPHIPIRF RHPPIAGPVH DVFGDAIHDI FQKMCPILSE</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="legend" id="legendContainer">
                    <p style="width: 100%; text-align: center; color: var(--text-light); padding: 20px;">
                        <i class="fas fa-list"></i> 标记图例将显示在这里
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sequenceInput = document.getElementById('sequenceInput');
            const groupSizeInput = document.getElementById('groupSize');
            const aaPerLineInput = document.getElementById('aaPerLine');
            const spaceCountInput = document.getElementById('spaceCount');
            const startPosInput = document.getElementById('startPos');
            const endPosInput = document.getElementById('endPos');
            const markerColorInput = document.getElementById('markerColor');
            const markerNameInput = document.getElementById('markerName');
            const markerTypeSelect = document.getElementById('markerType');
            const addMarkerBtn = document.getElementById('addMarkerBtn');
            const markerList = document.getElementById('markerList');
            const submitBtn = document.getElementById('submitBtn');
            const clearBtn = document.getElementById('clearBtn');
            const resetBtn = document.getElementById('resetBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const downloadFormat = document.getElementById('downloadFormat');
            const outputContainer = document.getElementById('outputContainer');
            const legendContainer = document.getElementById('legendContainer');
            const lineSpacingInput = document.getElementById('lineSpacing');
            const lineSpacingValue = document.getElementById('lineSpacingValue');
            const exportProgress = document.getElementById('exportProgress');
            const exportProgressBar = document.getElementById('exportProgressBar');
            const exportProgressInfo = document.getElementById('exportProgressInfo');
            const imageQuality = document.getElementById('imageQuality');
            const qualitySelector = document.getElementById('qualitySelector');
            const resolutionSelector = document.getElementById('resolutionSelector');
            const highresInfo = document.getElementById('highresInfo');
            const includeLegend = document.getElementById('includeLegend');
            const backgroundColorInput = document.getElementById('backgroundColor');
            const imageResolution = document.getElementById('imageResolution');
            
            let markers = [];
            let formattedSequenceText = "";
            let formattedSequenceData = null;
            let lineSpacing = 1.8;
            
            // 更新行间距显示
            lineSpacingInput.addEventListener('input', function() {
                lineSpacing = parseFloat(this.value);
                lineSpacingValue.textContent = lineSpacing.toFixed(1);
                
                // 如果已有格式化结果，重新应用行间距
                if (outputContainer.innerHTML && !outputContainer.innerHTML.includes('placeholder')) {
                    applyLineSpacing();
                }
            });
            
            // 监听格式选择变化
            downloadFormat.addEventListener('change', function() {
                if (this.value === 'png' || this.value === 'jpg' || this.value === 'tif') {
                    qualitySelector.style.display = 'flex';
                    resolutionSelector.style.display = 'flex';
                    highresInfo.style.display = 'flex';
                } else {
                    qualitySelector.style.display = 'none';
                    resolutionSelector.style.display = 'none';
                    highresInfo.style.display = 'none';
                }
            });
            
            // 应用行间距
            function applyLineSpacing() {
                const sequenceLines = outputContainer.querySelectorAll('.sequence-line');
                sequenceLines.forEach(line => {
                    line.style.lineHeight = `${lineSpacing}`;
                    line.style.minHeight = `${lineSpacing * 1.5}em`;
                });
            }
            
            // 添加标记
            addMarkerBtn.addEventListener('click', function() {
                const startPos = parseInt(startPosInput.value);
                const endPos = parseInt(endPosInput.value);
                const color = markerColorInput.value;
                const name = markerNameInput.value || `标记${markers.length + 1}`;
                const type = markerTypeSelect.value;
                
                if (isNaN(startPos)) {
                    alert('请输入有效的起始位置');
                    return;
                }
                
                if (isNaN(endPos)) {
                    alert('请输入有效的结束位置');
                    return;
                }
                
                if (startPos > endPos) {
                    alert('起始位置不能大于结束位置');
                    return;
                }
                
                const marker = {
                    start: startPos,
                    end: endPos,
                    color: color,
                    name: name,
                    type: type
                };
                
                markers.push(marker);
                renderMarkerList();
                
                // 重置输入
                startPosInput.value = endPos + 1;
                endPosInput.value = endPos + 10;
                markerNameInput.value = '';
            });
            
            // 渲染标记列表
            function renderMarkerList() {
                if (markers.length === 0) {
                    markerList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px;"><i class="fas fa-inbox"></i> 暂无标记序列</p>';
                    return;
                }
                
                markerList.innerHTML = '';
                
                markers.forEach((marker, index) => {
                    const markerItem = document.createElement('div');
                    markerItem.className = 'marker-item fade-in';
                    markerItem.style.borderLeftColor = marker.color;
                    
                    const markerDetails = document.createElement('div');
                    markerDetails.className = 'marker-details';
                    
                    const colorPreview = document.createElement('span');
                    colorPreview.className = 'color-preview';
                    colorPreview.style.backgroundColor = marker.color;
                    
                    const markerText = document.createElement('span');
                    markerText.innerHTML = `${marker.name} (${marker.start}-${marker.end}) <small>${marker.type === 'background' ? '背景' : '字符'}</small>`;
                    
                    markerDetails.appendChild(colorPreview);
                    markerDetails.appendChild(markerText);
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn-remove';
                    removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    removeBtn.addEventListener('click', function() {
                        markers.splice(index, 1);
                        renderMarkerList();
                    });
                    
                    markerItem.appendChild(markerDetails);
                    markerItem.appendChild(removeBtn);
                    
                    markerList.appendChild(markerItem);
                });
            }
            
            // 提交处理
            submitBtn.addEventListener('click', function() {
                const sequence = sequenceInput.value.trim();
                const groupSize = parseInt(groupSizeInput.value);
                const aaPerLine = parseInt(aaPerLineInput.value);
                const spaceCount = parseInt(spaceCountInput.value) || 1;
                const numberPosition = document.querySelector('input[name="numberPosition"]:checked').value;
                
                if (!sequence) {
                    alert('请输入蛋白序列');
                    return;
                }
                
                if (isNaN(groupSize) || groupSize < 1) {
                    alert('分组大小必须是大于0的数字');
                    return;
                }
                
                if (isNaN(aaPerLine) || aaPerLine < 1) {
                    alert('每行氨基酸数必须是大于0的数字');
                    return;
                }
                
                // 提取纯序列（去除FASTA标题等）
                let pureSequence = sequence;
                if (sequence.startsWith('>')) {
                    const lines = sequence.split('\n');
                    pureSequence = lines.slice(1).join('').replace(/\s/g, '');
                } else {
                    pureSequence = sequence.replace(/\s/g, '');
                }
                
                if (pureSequence.length > 100000) {
                    alert('序列长度不能超过100000个字符');
                    return;
                }
                
                // 格式化序列
                const formattedSequence = formatSequence(pureSequence, groupSize, aaPerLine, spaceCount, numberPosition);
                outputContainer.innerHTML = formattedSequence.html;
                formattedSequenceText = formattedSequence.text;
                formattedSequenceData = formattedSequence.data;
                
                // 应用行间距
                applyLineSpacing();
                
                // 渲染图例
                renderLegend();
            });
            
            // 优化后的格式化序列函数 - 完美对齐
            function formatSequence(sequence, groupSize, aaPerLine, spaceCount, numberPosition) {
                let htmlOutput = '';
                let textOutput = '';
                const dataOutput = [];
                const totalLength = sequence.length;
                const spaceStr = ' '.repeat(spaceCount);
                
                // 计算需要多少行
                const lines = Math.ceil(totalLength / aaPerLine);
                
                for (let lineIndex = 0; lineIndex < lines; lineIndex++) {
                    const lineStart = lineIndex * aaPerLine;
                    const lineEnd = Math.min(lineStart + aaPerLine, totalLength);
                    const lineSeq = sequence.substring(lineStart, lineEnd);
                    
                    // 添加行号
                    const lineNumber = lineStart + 1;
                    const lineNumberClass = numberPosition === 'left' ? 'line-number-left' : 'line-number-right';
                    const lineNumberElement = `<div class="line-number ${lineNumberClass}">${lineNumber}</div>`;
                    
                    // 创建分组内容
                    let htmlLine = '';
                    let textLine = '';
                    const groupsInLine = Math.ceil(lineSeq.length / groupSize);
                    const lineData = {
                        lineNumber: lineNumber,
                        groups: []
                    };
                    
                    for (let groupIndex = 0; groupIndex < groupsInLine; groupIndex++) {
                        const groupStart = groupIndex * groupSize;
                        const groupEnd = Math.min(groupStart + groupSize, lineSeq.length);
                        const groupSeq = lineSeq.substring(groupStart, groupEnd);
                        
                        // 处理分组内的标记
                        let htmlGroup = '';
                        let currentMarker = null;
                        let currentSegment = '';
                        const groupData = {
                            text: groupSeq,
                            segments: []
                        };
                        
                        for (let i = 0; i < groupSeq.length; i++) {
                            const globalPos = lineStart + groupStart + i + 1;
                            const char = groupSeq[i];
                            const marker = findMarkerForPosition(globalPos);
                            
                            // 如果标记改变或序列结束
                            if (marker !== currentMarker) {
                                if (currentSegment) {
                                    if (currentMarker) {
                                        if (currentMarker.type === 'background') {
                                            htmlGroup += `<span class="continuous-highlight" style="background-color: ${currentMarker.color}">${currentSegment}</span>`;
                                        } else {
                                            // 字符颜色标记 - 确保字体一致且不加粗
                                            htmlGroup += `<span class="highlight-text" style="color: ${currentMarker.color}">${currentSegment}</span>`;
                                        }
                                    } else {
                                        htmlGroup += currentSegment;
                                    }
                                    
                                    // 保存分段数据
                                    if (currentSegment) {
                                        groupData.segments.push({
                                            text: currentSegment,
                                            marker: currentMarker
                                        });
                                    }
                                }
                                currentSegment = '';
                                currentMarker = marker;
                            }
                            
                            currentSegment += char;
                        }
                        
                        // 添加最后一个片段
                        if (currentSegment) {
                            if (currentMarker) {
                                if (currentMarker.type === 'background') {
                                    htmlGroup += `<span class="continuous-highlight" style="background-color: ${currentMarker.color}">${currentSegment}</span>`;
                                } else {
                                    htmlGroup += `<span class="highlight-text" style="color: ${currentMarker.color}">${currentSegment}</span>`;
                                }
                            } else {
                                htmlGroup += currentSegment;
                            }
                            
                            // 保存分段数据
                            if (currentSegment) {
                                groupData.segments.push({
                                    text: currentSegment,
                                    marker: currentMarker
                                });
                            }
                        }
                        
                        // 确保每个分组长度一致（用空格填充不足部分）
                        if (groupSeq.length < groupSize) {
                            const spaces = ' '.repeat(groupSize - groupSeq.length);
                            htmlGroup += spaces;
                        }
                        
                        htmlLine += htmlGroup;
                        textLine += groupSeq;
                        
                        // 在分组之间添加空格（最后一个分组不加）
                        if (groupIndex < groupsInLine - 1) {
                            htmlLine += spaceStr;
                            textLine += spaceStr;
                        }
                        
                        lineData.groups.push(groupData);
                    }
                    
                    // 根据位置设置行号位置
                    if (numberPosition === 'left') {
                        htmlOutput += `<div class="sequence-line fade-in">${lineNumberElement}<div class="sequence-content">${htmlLine}</div></div>`;
                        // 使用固定宽度6个字符对齐行号
                        textOutput += `${lineNumber.toString().padStart(6, ' ')}  ${textLine}\n`;
                    } else {
                        htmlOutput += `<div class="sequence-line fade-in"><div class="sequence-content">${htmlLine}</div>${lineNumberElement}</div>`;
                        textOutput += `${textLine}  ${lineNumber.toString().padStart(6, ' ')}\n`;
                    }
                    
                    dataOutput.push(lineData);
                }
                
                return {
                    html: htmlOutput,
                    text: textOutput,
                    data: {
                        sequence: sequence,
                        groupSize: groupSize,
                        aaPerLine: aaPerLine,
                        spaceCount: spaceCount,
                        numberPosition: numberPosition,
                        markers: markers,
                        lines: dataOutput
                    }
                };
            }
            
            // 查找位置对应的标记
            function findMarkerForPosition(position) {
                for (const marker of markers) {
                    if (position >= marker.start && position <= marker.end) {
                        return marker;
                    }
                }
                return null;
            }
            
            // 渲染图例
            function renderLegend() {
                if (markers.length === 0) {
                    legendContainer.innerHTML = '<p style="width: 100%; text-align: center; color: var(--text-light); padding: 20px;"><i class="fas fa-list"></i> 标记图例将显示在这里</p>';
                    return;
                }
                
                let legendHTML = `
                    <div class="legend-header" id="legendHeader">
                        <div class="legend-title">
                            <i class="fas fa-legend legend-icon"></i> 标记图例 (${markers.length}项)
                        </div>
                        <div class="legend-toggle" id="legendToggle">
                            <i class="fas fa-chevron-up"></i>
                        </div>
                    </div>
                    <div class="legend-items" id="legendItems">
                `;
                
                markers.forEach(marker => {
                    legendHTML += `
                        <div class="legend-item fade-in">
                            <span class="color-preview" style="background-color: ${marker.color}"></span>
                            <span>${marker.name} (${marker.start}-${marker.end}) 
                                <small>${marker.type === 'background' ? '背景' : '字符'}</small>
                            </span>
                        </div>
                    `;
                });
                
                legendHTML += '</div>';
                legendContainer.innerHTML = legendHTML;
                
                // 添加折叠/展开功能
                const legendToggle = document.getElementById('legendToggle');
                const legendItems = document.getElementById('legendItems');
                
                // 默认折叠图例
                legendItems.classList.add('collapsed');
                legendToggle.querySelector('i').classList.remove('fa-chevron-up');
                legendToggle.querySelector('i').classList.add('fa-chevron-down');
                
                legendToggle.addEventListener('click', function() {
                    legendItems.classList.toggle('collapsed');
                    const icon = this.querySelector('i');
                    if (legendItems.classList.contains('collapsed')) {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    } else {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                });
            }
            
            // 清除按钮
            clearBtn.addEventListener('click', function() {
                sequenceInput.value = '';
                outputContainer.innerHTML = '<div class="placeholder"><i class="fas fa-file-medical"></i><h3>提交后，格式化结果将显示在这里</h3><p>设置参数并点击"提交格式化"按钮生成结果</p><div class="example-sequence"><div class="sequence-line"><div class="line-number line-number-left">1</div><div class="sequence-content">MEKVNEERDA VFEDHIGDRR MRKGQAVDFC HWVSHLIATE</div></div><div class="sequence-line"><div class="line-number line-number-left">41</div><div class="sequence-content">IHVSGDQLKG QRHKQEDRFL LEEAFADEME KTSYDVEVAD</div></div><div class="sequence-line"><div class="line-number line-number-left">81</div><div class="sequence-content">TPQPHIPIRF RHPPIAGPVH DVFGDAIHDI FQKMCPILSE</div></div></div></div>';
                legendContainer.innerHTML = '<p style="width: 100%; text-align: center; color: var(--text-light); padding: 20px;"><i class="fas fa-list"></i> 标记图例将显示在这里</p>';
                formattedSequenceData = null;
            });
            
            // 重置按钮
            resetBtn.addEventListener('click', function() {
                sequenceInput.value = 'MEKVNEERDAVFEDHIGDRRMKRGQAVDFCHWVSHLIATEIHVSGDQLKGQRHKQEDRFLLEEAFADEMEKTSYDVEVADTPQPHIPIRFRHPPIAGPVHDVFGDAIHDIFQKMCPILSEKWSGRSVRSLLEEAFADEMEKTSYDVEVADTPQPHIPIRFRHPPIAGPVHDVFGDAIHDIFQKMCPILSEKWSG';
                groupSizeInput.value = '10';
                aaPerLineInput.value = '80';
                spaceCountInput.value = '1';
                document.querySelector('input[name="numberPosition"][value="left"]').checked = true;
                startPosInput.value = '1';
                endPosInput.value = '10';
                markerColorInput.value = '#FF6B6B';
                markerNameInput.value = '';
                markerTypeSelect.value = 'background';
                lineSpacingInput.value = '1.8';
                lineSpacingValue.textContent = '1.8';
                markers = [];
                renderMarkerList();
                outputContainer.innerHTML = '<div class="placeholder"><i class="fas fa-file-medical"></i><h3>提交后，格式化结果将显示在这里</h3><p>设置参数并点击"提交格式化"按钮生成结果</p><div class="example-sequence"><div class="sequence-line"><div class="line-number line-number-left">1</div><div class="sequence-content">MEKVNEERDA VFEDHIGDRR MRKGQAVDFC HWVSHLIATE</div></div><div class="sequence-line"><div class="line-number line-number-left">41</div><div class="sequence-content">IHVSGDQLKG QRHKQEDRFL LEEAFADEME KTSYDVEVAD</div></div><div class="sequence-line"><div class="line-number line-number-left">81</div><div class="sequence-content">TPQPHIPIRF RHPPIAGPVH DVFGDAIHDI FQKMCPILSE</div></div></div></div>';
                legendContainer.innerHTML = '<p style="width: 100%; text-align: center; color: var(--text-light); padding: 20px;"><i class="fas fa-list"></i> 标记图例将显示在这里</p>';
                formattedSequenceData = null;
            });
            
            // 下载功能
            downloadBtn.addEventListener('click', function() {
                if (!formattedSequenceData) {
                    alert('请先提交格式化序列');
                    return;
                }
                
                const format = downloadFormat.value;
                const sequenceLines = formattedSequenceData.lines.length;
                const MAX_LINES_FOR_IMAGE = 1000;
                
                if ((format === 'png' || format === 'jpg' || format === 'tif') && sequenceLines > MAX_LINES_FOR_IMAGE) {
                    if (!confirm(`序列过长（${sequenceLines}行），图片导出可能耗时较长。是否继续导出图片？`)) {
                        return;
                    }
                }
                
                if (format === 'txt') {
                    downloadAsTXT();
                } else if (format === 'svg') {
                    downloadAsSVG();
                } else {
                    downloadAsImage(format);
                }
            });
            
            // 下载为TXT
            function downloadAsTXT() {
                const blob = new Blob([formattedSequenceText], {type: 'text/plain'});
                const link = document.createElement('a');
                link.download = '蛋白序列格式化结果.txt';
                link.href = URL.createObjectURL(blob);
                link.click();
            }
            
            // 下载为SVG矢量图 - 修复字符颜色标记问题
            function downloadAsSVG() {
                // 获取格式化结果
                if (!formattedSequenceData) return;
                
                const sequenceLines = formattedSequenceData.lines;
                if (!sequenceLines.length) {
                    alert('没有序列可导出');
                    return;
                }
                
                // 计算最大行号长度
                const maxLineNumber = sequenceLines.length * formattedSequenceData.aaPerLine + 1;
                const lineNumberWidth = maxLineNumber.toString().length;
                const lineNumberAreaWidth = (lineNumberWidth * 10) + 20; // 10px per character + padding
                
                // 字符尺寸
                const charWidth = 10;
                const charHeight = 18;
                const lineHeight = parseInt(lineSpacing * 25);
                
                // 获取参数
                const groupSize = formattedSequenceData.groupSize;
                const spaceCount = formattedSequenceData.spaceCount || 1;
                const numberPosition = formattedSequenceData.numberPosition;
                
                // 创建SVG容器
                const width = 1200;
                let height = sequenceLines.length * lineHeight + 50;
                let svgContent = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="${width}px" height="${height}px" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
  <rect width="100%" height="100%" fill="white"/>
  <style>
    .sequence-text {
        font-family: 'Courier New', monospace;
        font-size: ${charHeight}px;
    }
    .line-number {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: ${charHeight}px;
        fill: #1a6dcc;
    }
    .background-marker {
        stroke: none;
    }
  </style>
`;
                
                // 起始坐标
                let yPos = 50;
                const xStart = numberPosition === 'left' ? lineNumberAreaWidth : 20;
                
                // 遍历每一行
                sequenceLines.forEach((line, lineIndex) => {
                    const lineNumber = line.lineNumber;
                    const groups = line.groups;
                    
                    // 绘制行号
                    if (lineNumber) {
                        const xNumber = numberPosition === 'left' ? 10 : width - lineNumberAreaWidth + 10;
                        svgContent += `<text x="${xNumber}" y="${yPos}" class="line-number">${lineNumber}</text>\n`;
                    }
                    
                    // 计算当前行起始位置
                    let xPos = xStart;
                    let charIndex = 0;
                    
                    // 遍历所有组
                    groups.forEach((group, groupIndex) => {
                        // 遍历组内的所有分段
                        group.segments.forEach(segment => {
                            const text = segment.text;
                            const marker = segment.marker;
                            
                            for (let i = 0; i < text.length; i++) {
                                const char = text[i];
                                if (char === ' ') {
                                    // 空格：不绘制，只移动x坐标
                                    xPos += charWidth;
                                } else {
                                    // 绘制背景标记
                                    if (marker && marker.type === 'background') {
                                        svgContent += `<rect x="${xPos}" y="${yPos - charHeight + 3}" width="${charWidth}" height="${charHeight}" fill="${marker.color}" class="background-marker" />\n`;
                                    }
                                    
                                    // 绘制字符 - 修复字符颜色问题
                                    if (marker && marker.type === 'text') {
                                        // 字符颜色标记
                                        svgContent += `<text x="${xPos}" y="${yPos}" class="sequence-text" fill="${marker.color}">${char}</text>\n`;
                                    } else {
                                        // 默认颜色或背景标记
                                        svgContent += `<text x="${xPos}" y="${yPos}" class="sequence-text">${char}</text>\n`;
                                    }
                                    
                                    xPos += charWidth;
                                    charIndex++;
                                }
                            }
                        });
                        
                        // 在分组之间添加空格（最后一个分组不加）
                        if (groupIndex < groups.length - 1) {
                            xPos += charWidth * spaceCount;
                        }
                    });
                    
                    yPos += lineHeight;
                });
                
                // 添加图例（如果用户选择包含图例）
                if (markers.length > 0 && includeLegend.checked) {
                    yPos += 30; // 添加一些垂直间距
                    let xLegend = 20;
                    let currentRowY = yPos; // 当前行的Y坐标
                    const legendItemWidth = 250; // 每个图例项的宽度
                    const legendItemHeight = 40; // 每个图例项的高度
                    const horizontalSpacing = 20; // 图例项之间的水平间距
                    const maxWidth = width - 40; // 最大宽度
                    
                    // 添加图例标题
                    svgContent += `<text x="20" y="${yPos}" font-family="Arial" font-size="20" font-weight="bold">图例</text>\n`;
                    yPos += 30;
                    currentRowY = yPos;
                    
                    // 绘制图例项
                    markers.forEach((marker, index) => {
                        // 检查当前行是否还能放下一个图例项
                        if (xLegend + legendItemWidth > maxWidth) {
                            // 换行
                            xLegend = 20;
                            currentRowY += legendItemHeight + 20; // 增加行高和间距
                        }
                        
                        // 绘制颜色方块
                        svgContent += `<rect x="${xLegend}" y="${currentRowY - 15}" width="20" height="20" fill="${marker.color}" />\n`;
                        
                        // 绘制图例文本
                        const textContent = `${marker.name} (${marker.start}-${marker.end})`;
                        svgContent += `<text x="${xLegend + 30}" y="${currentRowY}" font-family="Arial" font-size="16">${textContent}</text>\n`;
                        
                        // 绘制标记类型
                        const typeText = marker.type === 'background' ? '背景标记' : '字符标记';
                        svgContent += `<text x="${xLegend + 30}" y="${currentRowY + 20}" font-family="Arial" font-size="14" fill="#666">${typeText}</text>\n`;
                        
                        // 更新下一个图例项的X坐标
                        xLegend += legendItemWidth + horizontalSpacing;
                    });
                    
                    // 更新总高度为最后一行图例的底部位置
                    height = currentRowY + legendItemHeight + 50;
                }
                
                // 更新SVG高度
                svgContent += '</svg>';
                svgContent = svgContent.replace(`height="${height}px"`, `height="${height}px"`);
                svgContent = svgContent.replace(`viewBox="0 0 ${width} ${height}"`, `viewBox="0 0 ${width} ${height}"`);
                
                // 创建下载链接
                const blob = new Blob([svgContent], {type: 'image/svg+xml'});
                const link = document.createElement('a');
                link.download = 'Fasta序列美化结果.svg';
                link.href = URL.createObjectURL(blob);
                link.click();
            }
            
            // 使用Canvas绘制图片
            function downloadAsImage(format) {
                if (!formattedSequenceData) return;
                
                // 获取分辨率设置
                const resolution = parseFloat(imageResolution.value) || 1;
                const resolutionText = {
                    1: '72 DPI',
                    2: '150 DPI',
                    4: '300 DPI'
                }[resolution];
                
                // 显示导出进度
                exportProgress.style.display = 'block';
                exportProgressInfo.style.display = 'block';
                exportProgressBar.style.width = '0%';
                exportProgressInfo.textContent = `准备导出图片 (${resolutionText})...`;
                
                setTimeout(() => {
                    try {
                        // 获取设备像素比
                        const dpr = window.devicePixelRatio || 1;
                        
                        // 图片参数
                        const fontSize = 20 * resolution; // 根据分辨率放大字体
                        const charWidth = fontSize * 0.6; // 等宽字体比例
                        const lineHeight = fontSize * lineSpacing;
                        const padding = 40 * resolution;
                        const margin = 20 * resolution;
                        
                        // 计算画布尺寸
                        const maxLineLength = formattedSequenceData.aaPerLine * charWidth + 
                                            (Math.ceil(formattedSequenceData.aaPerLine / formattedSequenceData.groupSize) - 1) * 
                                            (formattedSequenceData.spaceCount * charWidth);
                        
                        // 行号区域宽度
                        const lineNumberWidth = Math.max(
                            5 * charWidth, 
                            (formattedSequenceData.lines.length * formattedSequenceData.aaPerLine + 1).toString().length * charWidth
                        );
                        
                        const logicalWidth = Math.ceil(lineNumberWidth + maxLineLength + padding * 2);
                        const logicalHeightPerPage = 10000 * resolution; // 每页最大高度
                        
                        // 计算总页数
                        const totalLines = formattedSequenceData.lines.length;
                        const linesPerPage = Math.floor((logicalHeightPerPage - padding * 2) / lineHeight);
                        const totalPages = Math.ceil(totalLines / linesPerPage);
                        
                        // 创建离屏Canvas
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // 设置等宽字体
                        ctx.font = `bold ${fontSize}px 'Courier New', monospace`;
                        
                        // 导出多页图片
                        let currentPage = 0;
                        
                        function renderNextPage() {
                            if (currentPage >= totalPages) {
                                // 完成导出
                                exportProgress.style.display = 'none';
                                exportProgressInfo.style.display = 'none';
                                return;
                            }
                            
                            // 更新进度
                            exportProgressBar.style.width = `${((currentPage + 1) / totalPages * 100)}%`;
                            exportProgressInfo.textContent = `正在导出第 ${currentPage + 1}/${totalPages} 页 (${resolutionText})...`;
                            
                            // 计算当前页行数
                            const startLine = currentPage * linesPerPage;
                            const endLine = Math.min(startLine + linesPerPage, totalLines);
                            const pageLines = endLine - startLine;
                            
                            // 设置画布尺寸（使用高分辨率）
                            const logicalHeight = padding * 2 + pageLines * lineHeight;
                            
                            // 添加图例高度（如果用户选择包含图例）
                            let legendHeight = 0;
                            if (markers.length > 0 && includeLegend.checked && currentPage === totalPages - 1) {
                                // 计算图例所需高度（每行40px，每行显示4个图例）
                                const rows = Math.ceil(markers.length / 4);
                                legendHeight = 80 + rows * 60;
                            }
                            
                            canvas.width = logicalWidth * dpr;
                            canvas.height = (logicalHeight + legendHeight) * dpr;
                            
                            // 缩放上下文以适应高分辨率
                            ctx.scale(dpr, dpr);
                            
                            // 填充背景（使用用户选择的背景颜色）
                            const bgColor = backgroundColorInput.value || '#FFFFFF';
                            ctx.fillStyle = bgColor;
                            ctx.fillRect(0, 0, logicalWidth, logicalHeight + legendHeight);
                            
                            // 设置等宽字体
                            ctx.font = `bold ${fontSize}px 'Courier New', monospace`;
                            
                            // 起始位置
                            let yPos = padding;
                            
                            // 绘制当前页的所有行
                            for (let i = startLine; i < endLine; i++) {
                                const line = formattedSequenceData.lines[i];
                                const lineNumber = line.lineNumber;
                                const groups = line.groups;
                                
                                // 绘制行号
                                ctx.fillStyle = '#1a6dcc';
                                ctx.fillText(lineNumber.toString().padStart(5, ' '), padding, yPos);
                                
                                // 绘制序列内容
                                let xPos = padding + lineNumberWidth + margin;
                                let charIndex = 0;
                                
                                // 遍历所有组
                                groups.forEach((group, groupIndex) => {
                                    // 遍历组内的所有分段
                                    group.segments.forEach(segment => {
                                        const text = segment.text;
                                        const marker = segment.marker;
                                        
                                        for (let j = 0; j < text.length; j++) {
                                            const char = text[j];
                                            if (char === ' ') {
                                                // 空格：不绘制，只移动x坐标
                                                xPos += charWidth;
                                            } else {
                                                // 绘制背景标记
                                                if (marker && marker.type === 'background') {
                                                    ctx.fillStyle = marker.color;
                                                    ctx.fillRect(xPos - 2, yPos - fontSize + 4, charWidth + 2, fontSize);
                                                }
                                                
                                                // 绘制字符
                                                ctx.fillStyle = (marker && marker.type === 'text') ? marker.color : '#000';
                                                ctx.fillText(char, xPos, yPos);
                                                
                                                xPos += charWidth;
                                                charIndex++;
                                            }
                                        }
                                    });
                                    
                                    // 在分组之间添加空格（最后一个分组不加）
                                    if (groupIndex < groups.length - 1) {
                                        xPos += charWidth * formattedSequenceData.spaceCount;
                                    }
                                });
                                
                                yPos += lineHeight;
                            }
                            
                            // 如果是最后一页，添加图例
                            if (currentPage === totalPages - 1 && markers.length > 0 && includeLegend.checked) {
                                // 添加图例标题
                                ctx.font = `bold ${20 * resolution}px Arial`;
                                ctx.fillStyle = '#333';
                                ctx.fillText('图例', padding, yPos + 40);
                                
                                // 设置图例位置
                                let xLegend = padding;
                                const legendStartY = yPos + 70; // 图例起始Y坐标
                                let currentLegendY = legendStartY;
                                const legendItemWidth = 250 * resolution; // 每个图例项的宽度
                                const legendItemHeight = 40 * resolution; // 每个图例项的高度
                                const horizontalSpacing = 20 * resolution; // 图例项之间的水平间距
                                
                                // 绘制图例项
                                ctx.font = `${16 * resolution}px Arial`;
                                markers.forEach((marker, index) => {
                                    // 检查当前行是否还能放下一个图例项
                                    if (xLegend + legendItemWidth > logicalWidth - padding) {
                                        xLegend = padding;
                                        currentLegendY += legendItemHeight + 20; // 换行，增加行高和间距
                                    }
                                    
                                    // 绘制颜色方块
                                    ctx.fillStyle = marker.color;
                                    ctx.fillRect(xLegend, currentLegendY - 12 * resolution, 20 * resolution, 20 * resolution);
                                    
                                    // 绘制图例文本
                                    ctx.fillStyle = '#333';
                                    ctx.fillText(`${marker.name} (${marker.start}-${marker.end})`, xLegend + 30 * resolution, currentLegendY);
                                    
                                    // 绘制标记类型
                                    ctx.fillStyle = '#666';
                                    ctx.font = `${14 * resolution}px Arial`;
                                    ctx.fillText(marker.type === 'background' ? '背景标记' : '字符标记', xLegend + 30 * resolution, currentLegendY + 20 * resolution);
                                    
                                    // 重置字体
                                    ctx.font = `${16 * resolution}px Arial`;
                                    
                                    // 更新下一个图例项的X坐标
                                    xLegend += legendItemWidth + horizontalSpacing;
                                });
                            }
                            
                            // 导出当前页
                            const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
                            const quality = parseFloat(imageQuality.value);
                            const link = document.createElement('a');
                            link.download = `Fasta序列美化结果_${currentPage + 1}_${resolutionText.replace(' ', '')}.${format}`;
                            link.href = canvas.toDataURL(mimeType, format === 'jpg' ? quality : 1);
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            // 继续下一页
                            currentPage++;
                            setTimeout(renderNextPage, 100);
                        }
                        
                        // 开始导出
                        renderNextPage();
                    } catch (error) {
                        console.error('导出图片出错:', error);
                        alert('导出图片时出错: ' + error.message);
                        exportProgress.style.display = 'none';
                        exportProgressInfo.style.display = 'none';
                    }
                }, 100);
            }
            
            // 初始化
            renderMarkerList();
        });
    </script>
</body>
</html>